{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-gray-900 to-gray-800">
    <!-- Lab Header -->
    <div class="bg-gray-800 border-b border-gray-700 p-6">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold text-blue-400 mb-2">
                <i class="bi bi-building"></i> Tech Lab Central Hub
            </h1>
            <p class="text-gray-300">Choose your specialization and begin your technical journey</p>
        </div>
    </div>

    <div class="container mx-auto p-6">
        <div class="grid lg:grid-cols-4 gap-6">
            <!-- Tech Lab Map -->
            <div class="lg:col-span-1">
                <div class="bg-gray-800 rounded-lg p-6 sticky top-6">
                    <h3 class="text-xl font-bold mb-4 text-center">
                        <i class="bi bi-map"></i> Laboratory Map
                    </h3>
                    <div id="room-list" class="space-y-3"></div>
                    
                    <!-- Progress Summary -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <h4 class="font-bold mb-3 text-center">Your Progress</h4>
                        <div id="progress-summary" class="space-y-2 text-sm"></div>
                    </div>

                    <!-- Quick Tools -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <h4 class="font-bold mb-3 text-center">Quick Tools</h4>
                        <div id="quick-inventory" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Main Lab Area -->
            <div class="lg:col-span-3">
                <div id="current-room" class="bg-gray-800 rounded-lg p-6 min-h-96">
                    <div id="room-content">
                        <div class="text-center py-12">
                            <i class="bi bi-arrow-left text-6xl text-blue-400 mb-4"></i>
                            <h2 class="text-2xl font-bold mb-4">Select a Laboratory</h2>
                            <p class="text-gray-400 mb-6">Choose a tech domain from the map to explore available challenges and start your learning journey.</p>
                            
                            <!-- Getting Started Tips -->
                            <div class="bg-gray-700 rounded-lg p-4 max-w-md mx-auto">
                                <h3 class="font-bold mb-2 text-yellow-400">
                                    <i class="bi bi-lightbulb"></i> Getting Started
                                </h3>
                                <ul class="text-sm text-left space-y-1">
                                    <li>• Start with the <strong>Coding Lab</strong> for fundamentals</li>
                                    <li>• Complete challenges to unlock new areas</li>
                                    <li>• Collect tools to help with advanced puzzles</li>
                                    <li>• Earn badges by mastering each domain</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Lab-specific functionality
    class LabInterface {
        constructor() {
            this.init();
        }

        async init() {
            this.setupChallengeSelection();
            // Wait for game to initialize, then load rooms and update progress
            if (window.game && window.game.roomManager) {
                await this.loadRoomsForLab();
                this.updateProgressSummary();
            }
        }

        async loadRoomsForLab() {
            try {
                // Force room list update
                await window.game.roomManager.updateRoomList();
                console.log('Rooms loaded successfully');
            } catch (error) {
                console.error('Failed to load rooms in lab:', error);
                this.showRoomLoadError();
            }
        }

        showRoomLoadError() {
            const roomList = document.getElementById('room-list');
            if (roomList) {
                roomList.innerHTML = `
                    <div class="text-center text-red-400 p-4">
                        <i class="bi bi-exclamation-triangle text-2xl mb-2"></i>
                        <p class="text-sm mb-2">Failed to load rooms</p>
                        <button onclick="window.labInterface.loadRoomsForLab()" 
                                class="text-xs bg-blue-600 px-2 py-1 rounded hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        setupChallengeSelection() {
            // Handle challenge selection differently in lab view
            document.addEventListener('click', (e) => {
                const challengeCard = e.target.closest('.challenge-card');
                if (challengeCard) {
                    const challengeId = challengeCard.dataset.challenge;
                    const challengeType = challengeCard.dataset.type;
                    
                    // Navigate to game view with challenge parameters
                    const url = `/game?challenge=${challengeType}&id=${challengeId}`;
                    window.location.href = url;
                }
            });
        }

        updateProgressSummary() {
            const progressSummary = document.getElementById('progress-summary');
            if (!progressSummary || !window.game) return;

            const progress = window.game.progress;
            progressSummary.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-400">Challenges:</span>
                    <span class="text-green-400 font-bold">${progress.completedChallenges.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Score:</span>
                    <span class="text-blue-400 font-bold">${progress.totalScore}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Badges:</span>
                    <span class="text-yellow-400 font-bold">${progress.badges.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Areas:</span>
                    <span class="text-purple-400 font-bold">${progress.unlockedRooms.length}/5</span>
                </div>
            `;
        }
    }

    // Wait for core scripts to load before initializing
    function initializeLab() {
        console.log('Lab page loading...');
        
        // Check if all required classes are available
        if (typeof RoomManager === 'undefined' || 
            typeof ChallengeManager === 'undefined' || 
            typeof InventoryManager === 'undefined' || 
            typeof ProgressManager === 'undefined' ||
            typeof GameCore === 'undefined') {
            console.error('Required classes not loaded yet...');
            return false;
        }
        
        // Initialize game core first
        window.game = new GameCore();
        
        // Wait a bit for game to fully initialize
        setTimeout(async () => {
            window.labInterface = new LabInterface();
            
            // Update progress summary periodically
            setInterval(() => {
                if (window.labInterface) {
                    window.labInterface.updateProgressSummary();
                }
            }, 5000);
        }, 500);
        
        return true;
    }

    // Initialize when core scripts are loaded
    if (window.coreScriptsLoaded) {
        // Scripts already loaded
        document.addEventListener('DOMContentLoaded', initializeLab);
    } else {
        // Wait for scripts to load
        window.addEventListener('coreScriptsLoaded', () => {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeLab);
            } else {
                initializeLab();
            }
        });
    }
</script>
{% endblock %}
